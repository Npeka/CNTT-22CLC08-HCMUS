USE MASTER
GO
IF DB_ID('DE_31') IS NOT NULL
	DROP DATABASE DE_31
GO
CREATE DATABASE DE_31
GO
USE DE_31
GO
CREATE TABLE SACH
(
	MASACH CHAR(4),
	TENSACH NVARCHAR(100),
	SOLUONG INT,
	DONGIA INT,
	MALOAI CHAR(2),
	KHTIEUBIEU INT

	CONSTRAINT PK_SACH
	PRIMARY KEY (MASACH)
)
CREATE TABLE KHACHHANG
(
	MALOAI CHAR(2),
	STT INT,
	HOTEN NVARCHAR(50),
	DIACHI NVARCHAR(100)

	CONSTRAINT PK_KHACHHANG
	PRIMARY KEY (MALOAI,STT)
)

ALTER TABLE SACH
ADD
	CONSTRAINT FK_SACH_KHACHHANG
	FOREIGN KEY (MALOAI, KHTIEUBIEU)
	REFERENCES KHACHHANG

INSERT KHACHHANG (MaLoai, STT, HoTen, DiaChi)
VALUES ('L1', 1, N'Nguyễn Thị Minh', N'123 Vườn Lài, Tân Phú'),
		('L1', 2, N'Trần Trung Nghĩa', N'45 Phú Thọ Hòa, Tân Phú'),
		('L2', 1, N'Vũ Ánh Nguyệt', N'11 Võ Văn Ngân, Thủ Đức')
SELECT * FROM KHACHHANG
--4. Cho biết danh sách khách hàng và tổng trị giá các hóa đơn đã mua
SELECT KH.*, SUM(SOLUONG * DONGIA) TONGTRIGIA
FROM KHACHHANG KH JOIN MUAHANG MH ON MH.MALOAI = KH.MALOAI  AND MH.SOTT = KH.STT
GROUP BY KH.MALOAI,KH.DIACHI,KH.HOTEN,KH.STT
-- 5. Cho biết thông tin khách hàng họ Nguyễn có mua hàng trong tháng 12/2009 --với số lượng > 10 SELECT KH.*FROM KHACHHANG KH JOIN MUAHANG MH ON MH.MALOAI = KH.MALOAI  AND MH.SOTT = KH.STTWHERE KH.HOTEN LIKE N'NGUYỄN %' AND MONTH(NgayMua) = 12 AND YEAR(NGAYMUA) = 2009AND SOLUONG > 10