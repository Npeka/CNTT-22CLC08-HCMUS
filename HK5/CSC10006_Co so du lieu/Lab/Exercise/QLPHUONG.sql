USE master
GO

IF DB_ID('QLPHUONG') IS NOT NULL
	DROP DATABASE QLPHUONG

CREATE DATABASE QLPHUONG
GO

USE QLPHUONG
GO

CREATE TABLE PHUONG
(
	IDPHUONG CHAR(4),
	IDCHUTICH CHAR(4),
	TENPHUONG NCHAR(20)

	CONSTRAINT PK_PHUONG
	PRIMARY KEY(IDPHUONG)
)

CREATE TABLE KHUPHO
(	
	IDKHUPHO INT,
	IDTRKHUPHO CHAR(4),
	IDPHUONG CHAR(4)

	CONSTRAINT PK_KHUPHO
	PRIMARY KEY(IDPHUONG, IDKHUPHO)
)

CREATE TABLE DAN
(
	IDDAN CHAR(4),
	IDKHUPHO INT,
	TEN NCHAR(20),
	TINHTRANG NCHAR(50),
	IDPHUONG CHAR(4)

	CONSTRAINT PK_DAN
	PRIMARY KEY(IDPHUONG, IDDAN)
)

CREATE TABLE TRUCKHUPHO
(
	IDDAN CHAR(4),
	IDKHUPHO INT,
	NGHIPHEP CHAR(5),
	IDPHUONG CHAR(4)

	CONSTRAINT PK_TRUCKHUPHO
	PRIMARY KEY(IDPHUONG, IDKHUPHO, IDDAN)
)

ALTER TABLE PHUONG
ADD CONSTRAINT FK_PHUONG_IDPHUONG_IDCHUTICH
	FOREIGN KEY(IDPHUONG, IDCHUTICH)
	REFERENCES DAN

ALTER TABLE KHUPHO
ADD CONSTRAINT FK_KHUPHO_IDPHUONG_IDTRKHUPHO
	FOREIGN KEY(IDPHUONG, IDTRKHUPHO)
	REFERENCES DAN

ALTER TABLE DAN
ADD CONSTRAINT FK_DAN_IDPHUONG
	FOREIGN KEY(IDPHUONG)
	REFERENCES PHUONG,

	CONSTRAINT FK_DAN_IDPHUONG_IDKHUPHO
	FOREIGN KEY(IDPHUONG, IDKHUPHO)
	REFERENCES KHUPHO

ALTER TABLE TRUCKHUPHO
ADD CONSTRAINT FK_TRUCKHUPHO_IDPHUONG_IDDAN
	FOREIGN KEY(IDPHUONG, IDDAN)
	REFERENCES DAN,

	CONSTRAINT FK_TRUCKHUPHO_IDPHUONG_IDKHUPHO
	FOREIGN KEY(IDPHUONG, IDKHUPHO)
	REFERENCES KHUPHO,

	CONSTRAINT FK_TRUCKHUPHO_IDPHUONG
	FOREIGN KEY(IDPHUONG)
	REFERENCES PHUONG

INSERT PHUONG(IDPHUONG, TENPHUONG)
VALUES ('PHA', N'Phường A'),
	   ('PHB', N'Phường B'),
	   ('PHC', N'Phường C')

INSERT KHUPHO(IDPHUONG, IDKHUPHO)
VALUES ('PHA', 1),
	   ('PHA', 2),
	   ('PHB', 1),
	   ('PHB', 2)

INSERT DAN(IDPHUONG, IDKHUPHO, TEN, TINHTRANG, IDDAN)
VALUES ('PHA', 1, N'Nguyễn Văn A', N'còn sống', 'NVA'),
	   ('PHA', 1, N'Nguyễn Văn B', N'còn sống', 'NVB'),
	   ('PHA', 2, N'Nguyễn Văn C', N'còn sống', 'NVC'),
	   ('PHA', 2, N'Nguyễn Văn D', N'qua đời', 'NVD'),
	   ('PHB', 1, N'Nguyễn Văn E', N'còn sống', 'NVE'),
	   ('PHB', 1, N'Nguyễn Văn F', N'qua đời', 'NVF'),
	   ('PHB', 2, N'Nguyễn Văn G', N'còn sống', 'NVG'),
	   ('PHB', 2, N'Nguyễn Văn H', N'còn sống', 'NVH')

INSERT TRUCKHUPHO(IDPHUONG, IDKHUPHO, IDDAN, NGHIPHEP)
VALUES ('PHA', 1, 'NVA', 'True'),
	   ('PHA', 1, 'NVB', 'False'),
	   ('PHB', 2, 'NVG', 'True'),
	   ('PHB', 2, 'NVH', 'False')

UPDATE PHUONG 
SET IDCHUTICH = 'NVA' WHERE IDPHUONG = 'PHA'
UPDATE PHUONG 
SET IDCHUTICH = 'NVE' WHERE IDPHUONG = 'PHB'

UPDATE KHUPHO
SET IDTRKHUPHO = 'NVA' WHERE IDPHUONG = 'PHA' AND IDKHUPHO = 1
UPDATE KHUPHO
SET IDTRKHUPHO = 'NVC' WHERE IDPHUONG = 'PHA' AND IDKHUPHO = 2
UPDATE KHUPHO
SET IDTRKHUPHO = 'NVE' WHERE IDPHUONG = 'PHB' AND IDKHUPHO = 1
UPDATE KHUPHO
SET IDTRKHUPHO = 'NVG' WHERE IDPHUONG = 'PHB' AND IDKHUPHO = 2

SELECT* FROM PHUONG
SELECT* FROM TRUCKHUPHO
SELECT* FROM DAN
SELECT* FROM KHUPHO